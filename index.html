<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Link Genie - Tracking Link Builder</title>
  <style>
    :root {
      --primary: #0096FF;
      --primary-hover: #007acc;
      --secondary: #f3f4f6;
      --secondary-hover: #e5e7eb;
      --text: #1f2937;
      --text-light: #6b7280;
      --error: #ef4444;
      --success: #10b981;
      --border: #e5e7eb;
      --background: #ffffff;
      --background-alt: #f9fafb;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.5;
      color: var(--text);
      background-color: var(--background-alt);
      margin: 0;
      padding: 0;
    }

    .dark-mode {
      --primary: #0096FF;
      --primary-hover: #33a6ff;
      --secondary: #374151;
      --secondary-hover: #4b5563;
      --text: #f9fafb;
      --text-light: #9ca3af;
      --border: #4b5563;
      --background: #111827;
      --background-alt: #1f2937;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
      margin-bottom: 2rem;
      border-bottom: 1px solid var(--border);
    }

    .app-title {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary);
      margin: 0;
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 1.5rem;
    }

    .tab {
      padding: 0.5rem 1rem;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      font-weight: 600;
      cursor: pointer;
      color: var(--text-light);
      transition: all 0.2s ease;
    }

    .tab.active {
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .card {
      background-color: var(--background);
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .form-col {
      flex: 1;
      min-width: 250px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    .platform-toggle {
      display: flex;
      border: 1px solid var(--border);
      border-radius: 0.375rem;
      overflow: hidden;
      margin-bottom: 1rem;
      width: fit-content;
    }

    .platform-btn {
      padding: 0.5rem 1rem;
      border: none;
      background: var(--secondary);
      font-weight: 600;
      cursor: pointer;
      font-size: 0.875rem;
    }

    .platform-btn.active {
      background-color: var(--primary);
      color: white;
    }

    input, textarea, select {
      width: 100%;
      padding: 0.625rem;
      font-size: 0.875rem;
      border: 1px solid var(--border);
      border-radius: 0.375rem;
      background-color: var(--background);
      color: var(--text);
      box-sizing: border-box;
    }

    textarea {
      font-family: monospace;
      min-height: 100px;
      resize: vertical;
      white-space: pre;
      overflow-wrap: normal;
      overflow-x: auto;
    }

    button {
      cursor: pointer;
      padding: 0.625rem 1rem;
      font-size: 0.875rem;
      font-weight: 600;
      border-radius: 0.375rem;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background-color: var(--primary);
      color: white;
      border: none;
    }

    .btn-primary:hover {
      background-color: var(--primary-hover);
    }

    .btn-secondary {
      background-color: var(--secondary);
      color: var(--text);
      border: none;
    }

    .btn-secondary:hover {
      background-color: var(--secondary-hover);
    }

    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn-outline:hover {
      background-color: var(--secondary);
    }

    .btn-icon {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
    }

    .parameters-list {
      border: 1px solid var(--border);
      border-radius: 0.375rem;
      overflow: hidden;
      margin-bottom: 1rem;
    }

    .parameters-header {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background-color: var(--secondary);
      font-weight: 600;
      font-size: 0.875rem;
    }

    .parameter-item {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-top: 1px solid var(--border);
      align-items: center;
    }

    .link-preview {
      background-color: var(--secondary);
      border-radius: 0.375rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
      overflow-x: auto;
      font-family: monospace;
      font-size: 0.875rem;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .toast {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      padding: 1rem;
      background-color: var(--success);
      color: white;
      border-radius: 0.375rem;
      font-weight: 600;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      transition: all 0.3s ease;
      transform: translateY(150%);
      opacity: 0;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--secondary);
      transition: .4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--primary);
    }

    input:checked + .slider:before {
      transform: translateX(24px);
    }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .toggle-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .info-icon {
      cursor: help;
      color: var(--text-light);
      position: relative;
    }

    .info-icon:hover .tooltip {
      display: block;
    }

    .tooltip {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--background);
      color: var(--text);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 0.5rem;
      border-radius: 0.375rem;
      width: 200px;
      font-size: 0.75rem;
      font-weight: normal;
      z-index: 10;
      margin-bottom: 0.5rem;
      border: 1px solid var(--border);
    }

    .adjust-settings {
      background-color: var(--secondary);
      border-radius: 0.375rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .history-item {
      border: 1px solid var(--border);
      border-radius: 0.375rem;
      padding: 1rem;
      margin-bottom: 0.75rem;
      background-color: var(--background);
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .history-title {
      font-weight: 600;
      font-size: 1rem;
      margin: 0;
    }

    .history-meta {
      font-size: 0.75rem;
      color: var(--text-light);
      margin-bottom: 0.5rem;
    }

    .history-link {
      background-color: var(--secondary);
      padding: 0.5rem;
      border-radius: 0.375rem;
      font-family: monospace;
      font-size: 0.75rem;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
      margin-bottom: 0.5rem;
    }

    .action-row {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 0;
      color: var(--text-light);
    }

    .theme-toggle {
      background: none;
      border: none;
      color: var(--text);
      font-size: 1.25rem;
      cursor: pointer;
      padding: 0.25rem;
      width: 36px;
      height: 36px;
      border-radius: 0.375rem;
    }

    .theme-toggle:hover {
      background-color: var(--secondary);
    }

    .parameter-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }
    
    .parameter-option {
      border: 1px solid var(--border);
      border-radius: 0.375rem;
      padding: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
    }
    
    .parameter-option:hover {
      border-color: var(--primary);
      background-color: rgba(0, 150, 255, 0.05);
    }
    
    .parameter-option-name {
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--primary);
    }
    
    .parameter-option-desc {
      font-size: 0.75rem;
      color: var(--text-light);
    }
    
    .parameter-selector {
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: 0.375rem;
      padding: 1rem;
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 1rem;
    }
    
    .parameter-search {
      margin-bottom: 1rem;
    }
    
    .grid-2-columns {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    @media (max-width: 768px) {
      .form-row {
        flex-direction: column;
      }
      
      .parameter-item {
        grid-template-columns: 1fr 1fr auto;
        gap: 0.25rem;
      }
      
      .action-row {
        flex-wrap: wrap;
      }
      
      .history-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      
      .grid-2-columns {
        grid-template-columns: 1fr;
      }
      
      .parameter-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: var(--background);
      padding: 2rem;
      border-radius: 0.5rem;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-light);
      padding: 0;
    }

    .close-modal:hover {
      color: var(--text);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1 class="app-title">Link Genie</h1>
      <button class="theme-toggle" id="themeToggle">🌙</button>
    </header>
    
    <div class="tabs">
      <button class="tab active" data-tab="builder">Builder</button>
      <button class="tab" data-tab="history">History</button>
    </div>
    
    <div id="builder" class="tab-content active">
      <div class="card">
        <!-- Link Preview (moved to top) -->
        <div class="form-group">
          <label>Link Preview</label>
          <div class="link-preview" id="linkPreview"></div>
        </div>
        
        <div class="form-group">
          <div class="platform-toggle">
            <button class="platform-btn active" data-platform="Appsflyer">Appsflyer</button>
            <button class="platform-btn" data-platform="Adjust">Adjust</button>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-col">
            <div class="form-group">
              <label for="linkType">Link Type</label>
              <div class="platform-toggle" id="linkTypeToggle">
                <button class="platform-btn active" data-type="CTA">CTA</button>
                <button class="platform-btn" data-type="VTA">VTA</button>
              </div>
            </div>
          </div>
          
          <div class="form-col">
            <div class="form-group">
              <label for="appTrackerId" id="appTrackerIdLabel">App ID</label>
              <input type="text" id="appTrackerId" placeholder="com.example.app">
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="rawLink">Paste tracking link (optional)</label>
          <textarea id="rawLink" placeholder="https://app.appsflyer.com/com.example.app?pid=source&af_siteid=123"></textarea>
        </div>
        
        <!-- Build from scratch option -->
        <div class="form-group">
          <button id="buildFromScratchBtn" class="btn-primary">Build Link from Scratch</button>
          <div id="parameterSelector" class="parameter-selector" style="display: none;">
            <div class="parameter-search">
              <input type="text" id="searchParameters" placeholder="Search parameters...">
            </div>
            <div class="parameter-grid" id="parameterOptions"></div>
          </div>
        </div>
        
        <!-- Adjust Settings (hidden by default) -->
        <div id="adjustSettings" class="adjust-settings" style="display:none;">
          <h3 style="margin-top: 0;">Adjust Settings</h3>
          
          <div class="toggle-row">
            <div class="toggle-label">
              <label for="prefixToggle">Add 'ad_' prefix to parameters</label>
              <span class="info-icon">ℹ️
                <span class="tooltip">When enabled, all parameters that don't already have the 'ad_' prefix will automatically get it added.</span>
              </span>
            </div>
            <label class="switch">
              <input type="checkbox" id="prefixToggle">
              <span class="slider"></span>
            </label>
          </div>
          
          <div class="toggle-row">
            <div class="toggle-label">
              <label for="trackerLimitToggle">Add tracker limit (250,000)</label>
              <span class="info-icon">ℹ️
                <span class="tooltip">Automatically adds the parameter tracker_limit=250000 to your link.</span>
              </span>
            </div>
            <label class="switch">
              <input type="checkbox" id="trackerLimitToggle">
              <span class="slider"></span>
            </label>
          </div>
          
          <div class="toggle-row">
            <div class="toggle-label">
              <label for="rejectedCallbackToggle">Add rejected install callback</label>
              <span class="info-icon">ℹ️
                <span class="tooltip">Adds a rejected install callback with the format: adj_rejected_install_callback=cpp_rcb{id}&rejection_reason={rejection_reason}</span>
              </span>
            </div>
            <label class="switch">
              <input type="checkbox" id="rejectedCallbackToggle">
              <span class="slider"></span>
            </label>
          </div>
        </div>
        
        <!-- Parameters Section with 2 column layout -->
        <div class="form-group">
          <div class="form-header">
            <label>Parameters</label>
            <button class="btn-primary btn-sm" id="addParamBtn">+ Add Parameter</button>
          </div>
          
          <div class="parameters-list">
            <div class="parameters-header">
              <div>Key</div>
              <div>Value</div>
              <div></div>
            </div>
            <div id="parametersList"></div>
          </div>
        </div>
        
        <!-- Event Tokens Section (for Adjust) -->
        <div id="eventTokensSection" class="form-group" style="display:none;">
          <div class="form-header">
            <label>Event Tokens</label>
            <button class="btn-primary btn-sm" id="addEventBtn">+ Add Event Token</button>
          </div>
          
          <div class="parameters-list">
            <div class="parameters-header">
              <div>Token</div>
              <div></div>
            </div>
            <div id="eventTokensList"></div>
          </div>
        </div>
        
        <!-- Link Name and Save -->
        <div class="form-group">
          <label for="linkName">Name the link</label>
          <input type="text" id="linkName" placeholder="My Awesome Campaign">
        </div>
        
        <div class="form-row">
          <div class="form-col">
            <button class="btn-outline" id="resetBtn">Reset to Sample</button>
          </div>
          <div class="form-col" style="text-align: right;">
            <button class="btn-primary" id="saveBtn">Save Link</button>
          </div>
        </div>
      </div>
    </div>
    
    <div id="history" class="tab-content">
      <div class="form-group">
        <div class="form-row">
          <div class="form-col">
            <input type="text" id="searchLinks" placeholder="Search links...">
          </div>
          <div class="form-col" style="flex: 0 0 auto;">
            <button class="btn-outline" id="clearHistoryBtn">Clear All</button>
          </div>
        </div>
      </div>
      
      <div id="linksHistory"></div>
    </div>
  </div>
  
  <!-- Success Toast -->
  <div id="toast" class="toast">Link copied to clipboard</div>

  <!-- Modal for confirming clear history -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Clear all links?</h3>
        <button class="close-modal" id="closeModal">&times;</button>
      </div>
      <p>Are you sure you want to clear all your saved links? This action cannot be undone.</p>
      <div style="display: flex; justify-content: space-between; margin-top: 1.5rem;">
        <button class="btn-outline" id="cancelClear">Cancel</button>
        <button class="btn-primary" id="confirmClear">Clear All</button>
      </div>
    </div>
  </div>

  <script>
    // AppsFlyer parameters
    const appsflyerParameters = [
      { key: "pid", description: "Uniquely identifies an AppsFlyer integrated partner." },
      { key: "c", description: "Provided by the advertiser or the publisher." },
      { key: "af_prt", description: "Agency Account Name for agency attribution." },
      { key: "af_mp", description: "Enable postbacks to publisher marketing partners." },
      { key: "clickid", description: "Ad network unique click identifier." },
      { key: "af_siteid", description: "Unique ID identifying the publisher." },
      { key: "af_sub_siteid", description: "Ad sub-network/Publisher ID." },
      { key: "af_c_id", description: "Provided by the advertiser/publisher." },
      { key: "af_adset", description: "Intermediate campaign level." },
      { key: "af_adset_id", description: "Provided by the advertiser/publisher." },
      { key: "af_ad", description: "Ad Name provided by the advertiser/publisher." },
      { key: "af_ad_id", description: "Provided by the advertiser/publisher." },
      { key: "af_ad_type", description: "Describes the ad's type." },
      { key: "af_ad_format", description: "Format of the advertisement." },
      { key: "af_click_lookback", description: "Lookback window for click attribution." },
      { key: "af_viewthrough_lookback", description: "View-through lookback window." },
      { key: "af_channel", description: "Media source channel." },
      { key: "af_keywords", description: "Used for text-targeted campaigns." },
      { key: "af_cost_model", description: "Cost model for attribution." },
      { key: "af_cost_currency", description: "Currency code for cost value." },
      { key: "af_cost_value", description: "Monetary value of cost." },
      { key: "af_sub1", description: "Custom optional advertiser parameter 1." },
      { key: "af_sub2", description: "Custom optional advertiser parameter 2." },
      { key: "af_sub3", description: "Custom optional advertiser parameter 3." },
      { key: "af_sub4", description: "Custom optional advertiser parameter 4." },
      { key: "af_sub5", description: "Custom optional advertiser parameter 5." },
      { key: "af_r", description: "Redirect users to specified URL." },
      { key: "af_web_dp", description: "Redirect desktop users to different web page." },
      { key: "af_dp", description: "URI scheme fallback for deep linking." },
      { key: "af_force_deeplink", description: "Force deep linking to specified activity." },
      { key: "af_ref", description: "Unique referrer for S2S click attribution." },
      { key: "is_incentivized", description: "Boolean for campaign type." },
      { key: "af_param_forwarding", description: "Control if link parameters are forwarded." },
      { key: "af_base_params_forward", description: "Controls forwarding of PID and C." },
      { key: "af_partner_account_id", description: "Advertiser's partner account ID." },
      { key: "redirect", description: "Marks link as S2S click (no redirect)." },
      { key: "af_ua", description: "Device User-Agent string." },
      { key: "af_ip", description: "Device IP address." },
      { key: "af_os_version", description: "Device OS version." },
      { key: "af_model", description: "Device model name." },
      { key: "af_media_type", description: "Placement of ad (app/web)." },
      { key: "deep_link_sub1", description: "Additional deep link value 1." },
      { key: "deep_link_sub2", description: "Additional deep link value 2." },
      { key: "deep_link_sub3", description: "Additional deep link value 3." },
      { key: "deep_link_sub4", description: "Additional deep link value 4." },
      { key: "deep_link_sub5", description: "Additional deep link value 5." },
      { key: "deep_link_value", description: "Targeted in-app content." },
      { key: "af_og_title", description: "Open Graph title for social preview." },
      { key: "af_og_description", description: "Open Graph description." },
      { key: "af_og_image", description: "Open Graph image for social preview." },
      { key: "is_retargeting", description: "Marks campaign as retargeting." },
      { key: "af_reengagement_window", description: "Retargeting attribution window." },
      { key: "af_video_total_length", description: "Duration of video ad." },
      { key: "af_video_played_length", description: "Viewed duration of video." },
      { key: "af_playable_played_length", description: "Played duration of playable." },
      { key: "af_ad_time_viewed", description: "Ad screen visibility duration." },
      { key: "af_ad_displayed_percent", description: "Percent of ad visible on screen." },
      { key: "af_audio_total_length", description: "Duration of audio ad." },
      { key: "af_audio_played_length", description: "Heard duration of audio ad." },
      { key: "advertising_id", description: "Google Advertising ID." },
      { key: "sha1_advertising_id", description: "SHA1 hash of Advertising ID." },
      { key: "md5_advertising_id", description: "MD5 hash of Advertising ID." },
      { key: "android_id", description: "Device Android ID." },
      { key: "sha1_android_id", description: "SHA1 hash of Android ID." },
      { key: "md5_android_id", description: "MD5 hash of Android ID." },
      { key: "imei", description: "Device IMEI." },
      { key: "sha1_imei", description: "SHA1 hash of IMEI." },
      { key: "md5_imei", description: "MD5 hash of IMEI." },
      { key: "oaid", description: "Open Anonymous Device ID." },
      { key: "sha1_oaid", description: "SHA1 hash of OAID." },
      { key: "md5_oaid", description: "MD5 hash of OAID." },
      { key: "af_android_url", description: "Redirect Android users to custom store." },
      { key: "sha1_el", description: "Hashed email for desktop to mobile." },
      { key: "fire_advertising_id", description: "Amazon Fire Advertising ID." },
      { key: "af_android_store_csl", description: "Custom Google Play store listing." },
      { key: "idfa", description: "iOS Identifier for Advertisers." },
      { key: "idfv", description: "iOS Identifier for Vendors." },
      { key: "af_ios_url", description: "Redirect iOS users to alternate URL." },
      { key: "af_ios_store_cpp", description: "iOS custom product page ID." },
      { key: "sha1_idfa", description: "SHA1 hash of IDFA." },
      { key: "sha1_idfv", description: "SHA1 hash of IDFV." },
      { key: "mac", description: "Device MAC address." },
      { key: "md5_idfa", description: "MD5 hash of IDFA." },
      { key: "md5_idfv", description: "MD5 hash of IDFV." },
      { key: "sha1_mac", description: "SHA1 hash of MAC address." },
    ];
    
    // State management
    const state = {
      platform: "Appsflyer",
      linkType: "CTA",
      appTrackerId: "",
      rawLink: "",
      parameters: [],
      eventTokens: [],
      prefixParameters: false,
      addTrackerLimit: false,
      addRejectedCallback: false,
      finalLink: "",
      linkName: "",
      links: [],
      linkCounter: 1, // For automatic link numbering
      theme: "light"
    };

    // DOM elements
    const elements = {
      platformButtons: document.querySelectorAll('.platform-btn[data-platform]'),
      linkTypeButtons: document.querySelectorAll('.platform-btn[data-type]'),
      appTrackerIdLabel: document.getElementById('appTrackerIdLabel'),
      appTrackerId: document.getElementById('appTrackerId'),
      rawLink: document.getElementById('rawLink'),
      adjustSettings: document.getElementById('adjustSettings'),
      prefixToggle: document.getElementById('prefixToggle'),
      trackerLimitToggle: document.getElementById('trackerLimitToggle'),
      rejectedCallbackToggle: document.getElementById('rejectedCallbackToggle'),
      parametersList: document.getElementById('parametersList'),
      addParamBtn: document.getElementById('addParamBtn'),
      eventTokensSection: document.getElementById('eventTokensSection'),
      eventTokensList: document.getElementById('eventTokensList'),
      addEventBtn: document.getElementById('addEventBtn'),
      linkPreview: document.getElementById('linkPreview'),
      linkName: document.getElementById('linkName'),
      saveBtn: document.getElementById('saveBtn'),
      resetBtn: document.getElementById('resetBtn'),
      tabs: document.querySelectorAll('.tab'),
      tabContents: document.querySelectorAll('.tab-content'),
      searchLinks: document.getElementById('searchLinks'),
      linksHistory: document.getElementById('linksHistory'),
      clearHistoryBtn: document.getElementById('clearHistoryBtn'),
      toast: document.getElementById('toast'),
      confirmModal: document.getElementById('confirmModal'),
      closeModal: document.getElementById('closeModal'),
      cancelClear: document.getElementById('cancelClear'),
      confirmClear: document.getElementById('confirmClear'),
      themeToggle: document.getElementById('themeToggle'),
      buildFromScratchBtn: document.getElementById('buildFromScratchBtn'),
      parameterSelector: document.getElementById('parameterSelector'),
      searchParameters: document.getElementById('searchParameters'),
      parameterOptions: document.getElementById('parameterOptions')
    };

    // Initialize app
    function init() {
      loadFromLocalStorage();
      setupEventListeners();
      updateUIBasedOnPlatform();
      renderParametersList();
      loadSampleLink();
      renderLinksHistory();
      populateParameterOptions();
      setTheme(state.theme);
      
      // Initialize link counter based on existing links
      if (state.links.length > 0) {
        const numbers = state.links
          .map(link => {
            const match = link.name.match(/^#(\d+)/);
            return match ? parseInt(match[1]) : 0;
          })
          .filter(num => !isNaN(num));
          
        state.linkCounter = numbers.length > 0 ? Math.max(...numbers) + 1 : 1;
      }
    }
    
    // Populate parameter options
    function populateParameterOptions() {
      elements.parameterOptions.innerHTML = '';
      
      appsflyerParameters.forEach(param => {
        const paramElement = document.createElement('div');
        paramElement.className = 'parameter-option';
        paramElement.dataset.key = param.key;
        paramElement.innerHTML = `
          <div class="parameter-option-name">${param.key}</div>
          <div class="parameter-option-desc">${param.description}</div>
        `;
        
        paramElement.addEventListener('click', () => {
          addParameter(param.key, '');
          elements.parameterSelector.style.display = 'none';
        });
        
        elements.parameterOptions.appendChild(paramElement);
      });
      
      // Add custom parameter option
      const customParam = document.createElement('div');
      customParam.className = 'parameter-option';
      customParam.innerHTML = `
        <div class="parameter-option-name">Custom Parameter</div>
        <div class="parameter-option-desc">Add your own custom parameter</div>
      `;
      
      customParam.addEventListener('click', () => {
        addParameter('', '');
        elements.parameterSelector.style.display = 'none';
      });
      
      elements.parameterOptions.appendChild(customParam);
    }
    
    // Filter parameter options
    function filterParameterOptions(query) {
      const options = elements.parameterOptions.querySelectorAll('.parameter-option');
      const lowerQuery = query.toLowerCase();
      
      options.forEach(option => {
        const key = option.querySelector('.parameter-option-name').textContent.toLowerCase();
        const desc = option.querySelector('.parameter-option-desc').textContent.toLowerCase();
        
        if (key.includes(lowerQuery) || desc.includes(lowerQuery) || key === 'custom parameter') {
          option.style.display = 'block';
        } else {
          option.style.display = 'none';
        }
      });
    }
    
    // Setup event listeners
    function setupEventListeners() {
      // Platform toggle
      elements.platformButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          elements.platformButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.platform = btn.dataset.platform;
          updateUIBasedOnPlatform();
          updateFinalLink();
          
          // Auto-generate link name when platform changes
          generateLinkName();
        });
      });
      
      // Link type toggle
      elements.linkTypeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          elements.linkTypeButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.linkType = btn.dataset.type;
          updateFinalLink();
          
          // Auto-generate link name when link type changes
          generateLinkName();
        });
      });
      
      // App/Tracker ID input
      elements.appTrackerId.addEventListener('input', (e) => {
        state.appTrackerId = e.target.value;
        updateFinalLink();
        
        // Auto-generate link name when app id changes
        generateLinkName();
      });
      
      // Raw link input
      elements.rawLink.addEventListener('input', (e) => {
        state.rawLink = e.target.value;
        if (state.rawLink.includes('http')) {
          parseRawLink();
          
          // Auto-generate link name after parsing
          generateLinkName();
        }
      });
      
      // Build from scratch button
      elements.buildFromScratchBtn.addEventListener('click', () => {
        elements.parameterSelector.style.display = elements.parameterSelector.style.display === 'none' ? 'block' : 'none';
      });
      
      // Parameter search
      elements.searchParameters.addEventListener('input', (e) => {
        filterParameterOptions(e.target.value);
      });
      
      // Adjust settings toggles
      elements.prefixToggle.addEventListener('change', (e) => {
        state.prefixParameters = e.target.checked;
        updateFinalLink();
      });
      
      elements.trackerLimitToggle.addEventListener('change', (e) => {
        state.addTrackerLimit = e.target.checked;
        updateFinalLink();
      });
      
      elements.rejectedCallbackToggle.addEventListener('change', (e) => {
        state.addRejectedCallback = e.target.checked;
        updateFinalLink();
      });
      
      // Add parameter button
      elements.addParamBtn.addEventListener('click', () => {
        elements.parameterSelector.style.display = 'block';
      });
      
      // Add event token button
      elements.addEventBtn.addEventListener('click', () => {
        addEventToken('');
      });
      
      // Save link button
      elements.saveBtn.addEventListener('click', saveLink);
      
      // Reset button
      elements.resetBtn.addEventListener('click', loadSampleLink);
      
      // Tab navigation
      elements.tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;
          elements.tabs.forEach(t => t.classList.remove('active'));
          elements.tabContents.forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tabName).classList.add('active');
        });
      });
      
      // Search links
      elements.searchLinks.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        renderLinksHistory(searchTerm);
      });
      
      // Clear history button
      elements.clearHistoryBtn.addEventListener('click', () => {
        if (state.links.length > 0) {
          elements.confirmModal.style.display = 'flex';
        }
      });
      
      // Confirm clear
      elements.confirmClear.addEventListener('click', () => {
        state.links = [];
        state.linkCounter = 1;
        saveToLocalStorage();
        renderLinksHistory();
        elements.confirmModal.style.display = 'none';
        showToast('All links have been cleared');
      });
      
      // Cancel clear
      elements.cancelClear.addEventListener('click', () => {
        elements.confirmModal.style.display = 'none';
      });
      
      // Close modal
      elements.closeModal.addEventListener('click', () => {
        elements.confirmModal.style.display = 'none';
      });
      
      // Click outside modal to close
      window.addEventListener('click', (e) => {
        if (e.target === elements.confirmModal) {
          elements.confirmModal.style.display = 'none';
        }
      });
      
      // Theme toggle
      elements.themeToggle.addEventListener('click', toggleTheme);
      
      // Link name input
      elements.linkName.addEventListener('input', (e) => {
        state.linkName = e.target.value;
      });
    }
    
    // Generate link name based on parameters
    function generateLinkName() {
      let appId = state.appTrackerId;
      let mediaSource = '';
      let sub3Value = '';
      
      // Find values from parameters
      state.parameters.forEach(param => {
        if (param.key === 'pid') {
          mediaSource = param.value;
        }
        if (param.key === 'af_sub3') {
          sub3Value = param.value;
        }
      });
      
      // Clean up values
      appId = appId.replace(/[{}'"\s]/g, '');
      mediaSource = mediaSource.replace(/[{}'"\s]/g, '');
      sub3Value = sub3Value.replace(/[{}'"\s]/g, '');
      
      // Generate name
      let name = `#${state.linkCounter}`;
      
      if (appId) {
        name += ` - ${appId}`;
      }
      
      if (mediaSource) {
        name += ` - ${mediaSource}`;
      }
      
      if (sub3Value) {
        name += ` - ${sub3Value}`;
      }
      
      name += ` ${state.linkType}`;
      
      state.linkName = name;
      elements.linkName.value = name;
    }
    
    // Update UI based on selected platform
    function updateUIBasedOnPlatform() {
      if (state.platform === 'Appsflyer') {
        elements.appTrackerIdLabel.textContent = 'App ID';
        elements.appTrackerId.placeholder = 'com.example.app';
        elements.adjustSettings.style.display = 'none';
        elements.eventTokensSection.style.display = 'none';
      } else {
        elements.appTrackerIdLabel.textContent = 'Tracker ID';
        elements.appTrackerId.placeholder = '1nxc2xqx';
        elements.adjustSettings.style.display = 'block';
        elements.eventTokensSection.style.display = 'block';
      }
    }
    
    // Load default sample link
    function loadSampleLink() {
      state.platform = "Appsflyer";
      state.linkType = "CTA";
      state.appTrackerId = "{app_id}";
      state.rawLink = "https://app.appsflyer.com/{app_id}?pid={media_source}&c={campaign_name}&af_prt={agency_name}";
      state.parameters = [
        { id: generateId(), key: "pid", value: "{media_source}" },
        { id: generateId(), key: "c", value: "{campaign_name}" },
        { id: generateId(), key: "af_prt", value: "{agency_name}" }
      ];
      state.eventTokens = [];
      state.prefixParameters = false;
      state.addTrackerLimit = false;
      state.addRejectedCallback = false;
      
      // Generate link name
      generateLinkName();
      
      // Update UI
      elements.platformButtons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.platform === state.platform);
      });
      
      elements.linkTypeButtons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === state.linkType);
      });
      
      elements.appTrackerId.value = state.appTrackerId;
      elements.rawLink.value = state.rawLink;
      elements.prefixToggle.checked = state.prefixParameters;
      elements.trackerLimitToggle.checked = state.addTrackerLimit;
      elements.rejectedCallbackToggle.checked = state.addRejectedCallback;
      elements.linkName.value = state.linkName;
      
      updateUIBasedOnPlatform();
      renderParametersList();
      renderEventTokensList();
      updateFinalLink();
    }
    
    // Parse raw link
    function parseRawLink() {
      try {
        const url = new URL(state.rawLink);
        
        // Detect platform
        if (url.hostname.includes('appsflyer.com')) {
          state.platform = 'Appsflyer';
          // Extract app ID from path
          const pathParts = url.pathname.split('/');
          if (pathParts.length > 1) {
            state.appTrackerId = pathParts[1];
          }
        } else if (url.hostname.includes('adjust.com')) {
          state.platform = 'Adjust';
          // Extract tracker ID from path
          const pathParts = url.pathname.split('/');
          if (pathParts.length > 1) {
            state.appTrackerId = pathParts[1];
          }
        }
        
        // Update platform buttons
        elements.platformButtons.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.platform === state.platform);
        });
        
        // Extract parameters
        const params = new URLSearchParams(url.search);
        const newParams = [];
        const newEventTokens = [];
        
        params.forEach((value, key) => {
          if (key.startsWith('event_callback_')) {
            // Event token for Adjust
            const token = key.replace('event_callback_', '');
            newEventTokens.push({
              id: generateId(),
              token: token
            });
          } else {
            newParams.push({
              id: generateId(),
              key: key,
              value: value
            });
          }
        });
        
        if (newParams.length > 0) {
          state.parameters = newParams;
        }
        
        if (newEventTokens.length > 0) {
          state.eventTokens = newEventTokens;
        }
        
        // Detect link type
        const hasClick = Array.from(params.entries()).some(
          ([key, value]) => key.includes('click') || value.includes('click')
        );
        
        const hasViewOrImpression = Array.from(params.entries()).some(
          ([key, value]) => 
            key.includes('view') || value.includes('view') || 
            key.includes('impression') || value.includes('impression')
        );
        
        if (hasClick) {
          state.linkType = 'CTA';
        } else if (hasViewOrImpression) {
          state.linkType = 'VTA';
        }
        
        // Update link type buttons
        elements.linkTypeButtons.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.type === state.linkType);
        });
        
        // Check for Adjust specific settings
        if (state.platform === 'Adjust') {
          // Check for tracker_limit
          state.addTrackerLimit = state.rawLink.includes('tracker_limit=250000');
          elements.trackerLimitToggle.checked = state.addTrackerLimit;
          
          // Check for rejected callback
          state.addRejectedCallback = state.rawLink.includes('adj_rejected_install_callback=');
          elements.rejectedCallbackToggle.checked = state.addRejectedCallback;
          
          // Check if parameters have ad_ prefix
          const relevantParams = state.parameters.filter(p => 
            !p.key.startsWith('event_callback_') && 
            p.key !== 'tracker_limit' && 
            p.key !== 'adj_rejected_install_callback'
          );
          
          if (relevantParams.length > 0) {
            state.prefixParameters = relevantParams.every(param => param.key.startsWith('ad_'));
            elements.prefixToggle.checked = state.prefixParameters;
          }
        }
        
        // Update UI
        elements.appTrackerId.value = state.appTrackerId;
        updateUIBasedOnPlatform();
        renderParametersList();
        renderEventTokensList();
        updateFinalLink();
      } catch (error) {
        console.error("Failed to parse URL:", error);
      }
    }
    
    // Update final link
    function updateFinalLink() {
      try {
        let baseUrl = "";
        
        if (state.platform === "Appsflyer") {
          baseUrl = `https://app.appsflyer.com/${state.appTrackerId}`;
        } else if (state.platform === "Adjust") {
          baseUrl = `https://app.adjust.com/${state.appTrackerId}`;
        }
        
        const searchParams = new URLSearchParams();
        let processedParameters = [...state.parameters];
        
        // Apply Adjust-specific modifications
        if (state.platform === "Adjust") {
          // Add ad_ prefix if enabled
          if (state.prefixParameters) {
            processedParameters = processedParameters.map(param => {
              if (!param.key.startsWith('ad_') && 
                  param.key !== 'tracker_limit' && 
                  param.key !== 'adj_rejected_install_callback') {
                return {
                  ...param,
                  key: `ad_${param.key}`
                };
              }
              return param;
            });
          }
          
          // Add tracker_limit parameter if enabled
          if (state.addTrackerLimit && !processedParameters.some(p => p.key === 'tracker_limit')) {
            processedParameters.push({
              id: generateId(),
              key: 'tracker_limit',
              value: '250000'
            });
          }
          
          // Add rejected install callback if enabled
          if (state.addRejectedCallback && !processedParameters.some(p => p.key === 'adj_rejected_install_callback')) {
            processedParameters.push({
              id: generateId(),
              key: 'adj_rejected_install_callback',
              value: `cpp_rcb0&rejection_reason={rejection_reason}`
            });
          }
        }
        
        // Add parameters
        processedParameters.forEach(param => {
          if (param.key && param.value) {
            searchParams.append(param.key, param.value);
          }
        });
        
        // Add event tokens for Adjust
        if (state.platform === "Adjust" && state.eventTokens.length > 0) {
          state.eventTokens.forEach((et, index) => {
            if (et.token) {
              searchParams.append(
                `event_callback_${et.token}`,
                `cpp_icb${index}&event_id=${et.token}`
              );
            }
          });
        }
        
        const queryString = searchParams.toString();
        const finalLink = queryString ? `${baseUrl}?${decodeURIComponent(queryString)}` : baseUrl;
        
        state.finalLink = finalLink;
        elements.linkPreview.textContent = finalLink;
      } catch (error) {
        console.error("Error generating final link:", error);
        elements.linkPreview.textContent = "Error generating link";
      }
    }
    
    // Render parameters list with 2 columns
    function renderParametersList() {
      elements.parametersList.innerHTML = '';
      
      // Create grid container
      const grid = document.createElement('div');
      grid.className = 'grid-2-columns';
      
      state.parameters.forEach(param => {
        const paramItem = document.createElement('div');
        paramItem.className = 'parameter-item';
        paramItem.innerHTML = `
          <input type="text" value="${escapeHtml(param.key)}" placeholder="Key" data-id="${param.id}" data-type="key">
          <input type="text" value="${escapeHtml(param.value)}" placeholder="Value" data-id="${param.id}" data-type="value">
          <button class="btn-outline btn-sm remove-param" data-id="${param.id}">&times;</button>
        `;
        grid.appendChild(paramItem);
      });
      
      elements.parametersList.appendChild(grid);
      
      // Add event listeners to parameter inputs
      document.querySelectorAll('[data-type="key"]').forEach(input => {
        input.addEventListener('input', handleParameterChange);
      });
      
      document.querySelectorAll('[data-type="value"]').forEach(input => {
        input.addEventListener('input', handleParameterChange);
      });
      
      // Add event listeners to remove buttons
      document.querySelectorAll('.remove-param').forEach(button => {
        button.addEventListener('click', removeParameter);
      });
    }
    
    // Render event tokens list
    function renderEventTokensList() {
      elements.eventTokensList.innerHTML = '';
      
      state.eventTokens.forEach(event => {
        const eventItem = document.createElement('div');
        eventItem.className = 'parameter-item';
        eventItem.innerHTML = `
          <input type="text" value="${escapeHtml(event.token)}" placeholder="Event Token" data-id="${event.id}" data-type="event-token">
          <div></div>
          <button class="btn-outline btn-sm remove-event" data-id="${event.id}">&times;</button>
        `;
        elements.eventTokensList.appendChild(eventItem);
      });
      
      // Add event listeners to event token inputs
      document.querySelectorAll('[data-type="event-token"]').forEach(input => {
        input.addEventListener('input', handleEventTokenChange);
      });
      
      // Add event listeners to remove buttons
      document.querySelectorAll('.remove-event').forEach(button => {
        button.addEventListener('click', removeEventToken);
      });
    }
    
    // Handle parameter change
    function handleParameterChange(e) {
      const id = e.target.dataset.id;
      const type = e.target.dataset.type;
      const value = e.target.value;
      
      const paramIndex = state.parameters.findIndex(p => p.id === id);
      if (paramIndex !== -1) {
        if (type === 'key') {
          state.parameters[paramIndex].key = value;
        } else if (type === 'value') {
          state.parameters[paramIndex].value = value;
        }
        updateFinalLink();
        
        // Update link name if pid or af_sub3 changed
        if (type === 'key' && (value === 'pid' || value === 'af_sub3')) {
          generateLinkName();
        } else if (type === 'value' && (state.parameters[paramIndex].key === 'pid' || state.parameters[paramIndex].key === 'af_sub3')) {
          generateLinkName();
        }
      }
    }
    
    // Handle event token change
    function handleEventTokenChange(e) {
      const id = e.target.dataset.id;
      const value = e.target.value;
      
      const tokenIndex = state.eventTokens.findIndex(t => t.id === id);
      if (tokenIndex !== -1) {
        state.eventTokens[tokenIndex].token = value;
        updateFinalLink();
      }
    }
    
    // Add parameter
    function addParameter(key, value) {
      const param = {
        id: generateId(),
        key: key,
        value: value
      };
      
      state.parameters.push(param);
      renderParametersList();
      updateFinalLink();
      
      // Update link name if pid or af_sub3 added
      if (key === 'pid' || key === 'af_sub3') {
        generateLinkName();
      }
    }
    
    // Remove parameter
    function removeParameter(e) {
      const id = e.target.dataset.id;
      
      // Check if we're removing pid or af_sub3
      const removedParam = state.parameters.find(p => p.id === id);
      const isPidOrSub3 = removedParam && (removedParam.key === 'pid' || removedParam.key === 'af_sub3');
      
      state.parameters = state.parameters.filter(p => p.id !== id);
      renderParametersList();
      updateFinalLink();
      
      // Update link name if we removed pid or af_sub3
      if (isPidOrSub3) {
        generateLinkName();
      }
    }
    
    // Add event token
    function addEventToken(token) {
      const event = {
        id: generateId(),
        token: token
      };
      
      state.eventTokens.push(event);
      renderEventTokensList();
      updateFinalLink();
    }
    
    // Remove event token
    function removeEventToken(e) {
      const id = e.target.dataset.id;
      state.eventTokens = state.eventTokens.filter(t => t.id !== id);
      renderEventTokensList();
      updateFinalLink();
    }
    
    // Save link
    function saveLink() {
      if (!state.linkName) {
        showToast('Please enter a name for the link');
        return;
      }
      
      if (!state.appTrackerId) {
        showToast('Please enter an App/Tracker ID');
        return;
      }
      
      const link = {
        id: generateId(),
        name: state.linkName,
        platform: state.platform,
        linkType: state.linkType,
        appTrackerId: state.appTrackerId,
        rawLink: state.rawLink,
        parameters: state.parameters,
        eventTokens: state.eventTokens,
        finalLink: state.finalLink,
        createdAt: Date.now()
      };
      
      state.links.unshift(link);
      state.linkCounter++; // Increment the link counter for next link
      saveToLocalStorage();
      renderLinksHistory();
      showToast('Link saved successfully');
      
      // Generate a new name for the next link
      generateLinkName();
      
      // Switch to history tab
      document.querySelector('.tab[data-tab="history"]').click();
    }
    
    // Render links history
    function renderLinksHistory(searchTerm = '') {
      elements.linksHistory.innerHTML = '';
      
      const filteredLinks = searchTerm 
        ? state.links.filter(link => link.name.toLowerCase().includes(searchTerm.toLowerCase()))
        : state.links;
      
      if (filteredLinks.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state';
        emptyState.textContent = state.links.length === 0
          ? 'You haven\'t created any links yet. Go to the Builder tab to create your first link!'
          : 'No links match your search query.';
        elements.linksHistory.appendChild(emptyState);
        return;
      }
      
      filteredLinks.forEach(link => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        historyItem.innerHTML = `
          <div class="history-header">
            <h3 class="history-title">${escapeHtml(link.name)}</h3>
            <div class="action-row">
              <button class="btn-outline btn-sm edit-link" data-id="${link.id}">Edit</button>
              <button class="btn-primary btn-sm copy-link" data-id="${link.id}">Copy</button>
              <button class="btn-outline btn-sm delete-link" data-id="${link.id}">&times;</button>
            </div>
          </div>
          <div class="history-meta">
            ${link.platform} | ${link.linkType} | Created: ${formatDate(link.createdAt)}
          </div>
          <div class="history-link">
            ${escapeHtml(link.finalLink)}
          </div>
        `;
        elements.linksHistory.appendChild(historyItem);
      });
      
      // Add event listeners
      document.querySelectorAll('.copy-link').forEach(button => {
        button.addEventListener('click', copyLink);
      });
      
      document.querySelectorAll('.delete-link').forEach(button => {
        button.addEventListener('click', deleteLink);
      });
      
      document.querySelectorAll('.edit-link').forEach(button => {
        button.addEventListener('click', editLink);
      });
    }
    
    // Copy link to clipboard
    async function copyLink(e) {
      const id = e.target.dataset.id;
      const link = state.links.find(l => l.id === id);
      
      if (link) {
        try {
          await navigator.clipboard.writeText(link.finalLink);
          showToast('Link copied to clipboard');
        } catch (error) {
          console.error('Failed to copy:', error);
          showToast('Failed to copy link');
        }
      }
    }
    
    // Delete link
    function deleteLink(e) {
      const id = e.target.dataset.id;
      state.links = state.links.filter(l => l.id !== id);
      saveToLocalStorage();
      renderLinksHistory(elements.searchLinks.value);
      showToast('Link deleted successfully');
    }
    
    // Edit link
    function editLink(e) {
      const id = e.target.dataset.id;
      const link = state.links.find(l => l.id === id);
      
      if (link) {
        state.platform = link.platform;
        state.linkType = link.linkType;
        state.appTrackerId = link.appTrackerId;
        state.rawLink = link.rawLink;
        state.parameters = [...link.parameters];
        state.eventTokens = [...link.eventTokens];
        state.finalLink = link.finalLink;
        state.linkName = link.name;
        
        // Check for Adjust settings
        if (state.platform === 'Adjust') {
          // Check for tracker_limit
          state.addTrackerLimit = link.rawLink.includes('tracker_limit=250000');
          
          // Check for rejected callback
          state.addRejectedCallback = link.rawLink.includes('adj_rejected_install_callback=');
          
          // Check if parameters have ad_ prefix
          const relevantParams = link.parameters.filter(p => 
            !p.key.startsWith('event_callback_') && 
            p.key !== 'tracker_limit' && 
            p.key !== 'adj_rejected_install_callback'
          );
          
          if (relevantParams.length > 0) {
            state.prefixParameters = relevantParams.every(param => param.key.startsWith('ad_'));
          }
        }
        
        // Update UI
        elements.platformButtons.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.platform === state.platform);
        });
        
        elements.linkTypeButtons.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.type === state.linkType);
        });
        
        elements.appTrackerId.value = state.appTrackerId;
        elements.rawLink.value = state.rawLink;
        elements.prefixToggle.checked = state.prefixParameters;
        elements.trackerLimitToggle.checked = state.addTrackerLimit;
        elements.rejectedCallbackToggle.checked = state.addRejectedCallback;
        elements.linkName.value = state.linkName;
        
        updateUIBasedOnPlatform();
        renderParametersList();
        renderEventTokensList();
        updateFinalLink();
        
        // Switch to builder tab
        document.querySelector('.tab[data-tab="builder"]').click();
      }
    }
    
    // Show toast message
    function showToast(message) {
      elements.toast.textContent = message;
      elements.toast.classList.add('show');
      
      setTimeout(() => {
        elements.toast.classList.remove('show');
      }, 3000);
    }
    
    // Toggle theme
    function toggleTheme() {
      const newTheme = state.theme === 'light' ? 'dark' : 'light';
      setTheme(newTheme);
      state.theme = newTheme;
      saveToLocalStorage();
    }
    
    // Set theme
    function setTheme(theme) {
      if (theme === 'dark') {
        document.body.classList.add('dark-mode');
        elements.themeToggle.textContent = '☀️';
      } else {
        document.body.classList.remove('dark-mode');
        elements.themeToggle.textContent = '🌙';
      }
    }
    
    // Save to localStorage
    function saveToLocalStorage() {
      const data = {
        links: state.links,
        theme: state.theme,
        linkCounter: state.linkCounter
      };
      
      localStorage.setItem('linkGenie', JSON.stringify(data));
    }
    
    // Load from localStorage
    function loadFromLocalStorage() {
      const data = localStorage.getItem('linkGenie');
      
      if (data) {
        const parsed = JSON.parse(data);
        state.links = parsed.links || [];
        state.theme = parsed.theme || 'light';
        state.linkCounter = parsed.linkCounter || 1;
      }
    }
    
    // Helper: Generate ID
    function generateId() {
      return Math.random().toString(36).substring(2, 15);
    }
    
    // Helper: Format date
    function formatDate(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleString();
    }
    
    // Helper: Escape HTML
    function escapeHtml(unsafe) {
      return unsafe
        .toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    
    // Initialize the app
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
